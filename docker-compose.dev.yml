version: "3.9"

services:
  fileupdate-server-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: fileupdate-server-dev
    # å¼€å‘æ¨¡å¼ï¼šä¸è‡ªåŠ¨é‡å¯ï¼Œæ–¹ä¾¿è°ƒè¯•
    environment:
      - NODE_ENV=development
      - PORT=3000
      - LANG=en_US.UTF-8
      - LANGUAGE=en_US.UTF-8
      - LC_ALL=en_US.UTF-8
      - LC_CTYPE=UTF-8
      - MAX_FILE_SIZE=209715200  # 200MB
      # å¼€å‘ç¯å¢ƒä½¿ç”¨JSONå­˜å‚¨ï¼ˆé¿å…åŸç”Ÿæ¨¡å—ç¼–è¯‘é—®é¢˜ï¼‰
      # å¦‚éœ€ä½¿ç”¨SQLiteï¼Œè¯·æ³¨é‡Šæ‰ä¸‹é¢ä¸¤è¡Œå¹¶å–æ¶ˆæ³¨é‡Šä¸‹é¢çš„è¡Œ
      - DB_DRIVER=json
      - DB_JSON_BASEDIR=./data
      # - DB_DRIVER=sqlite
      # - DB_SQLITE_FILE=./data/dev.sqlite
      # å¼€å‘ç¯å¢ƒä½¿ç”¨ç®€å•å¯†ç 
      - ADMIN_PASSWORD=admin123
      - JWT_SECRET=dev-jwt-secret-key-change-in-production
      - SESSION_SECRET=dev-session-secret-key-change-in-production
    ports:
      - "3000:3000"
    volumes:
      # æŒ‚è½½æºä»£ç ï¼Œæ”¯æŒçƒ­é‡è½½
      - .:/usr/src/app
      # node_moduleså°†åœ¨å®¹å™¨ä¸­å®‰è£…ï¼Œä¸æŒ‚è½½
      # æ•°æ®å’Œä¸Šä¼ æ–‡ä»¶æŒä¹…åŒ–
      - ./data:/usr/src/app/data
      - ./uploads:/usr/src/app/uploads
      - ./logs:/usr/src/app/logs
      # æ•°æ®æŒä¹…åŒ–
      - ./data:/usr/src/app/data
      - ./uploads:/usr/src/app/uploads
      # æ—¥å¿—æ–‡ä»¶æŒ‚è½½ï¼ˆå¯é€‰ï¼‰
      - ./logs:/usr/src/app/logs
    # å®æ—¶æ—¥å¿—è¾“å‡º
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    # å¼€å‘æ¨¡å¼ï¼šå¯ç”¨TTYå’Œstdin
    stdin_open: true
    tty: true
    # å¼€å‘ç¯å¢ƒï¼šä½¿ç”¨JSONå­˜å‚¨é¿å…åŸç”Ÿæ¨¡å—é—®é¢˜
    command: >
      bash -c "
        echo 'ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–...' &&
        npm install &&
        echo 'ğŸ”§ é‡æ–°ç¼–è¯‘åŸç”Ÿæ¨¡å—ï¼ˆå¦‚æœéœ€è¦ï¼‰...' &&
        npm rebuild better-sqlite3 2>/dev/null || echo 'åŸç”Ÿæ¨¡å—ç¼–è¯‘è·³è¿‡ï¼Œä½¿ç”¨JSONå­˜å‚¨' &&
        echo 'ğŸ”¥ å¯åŠ¨çƒ­é‡è½½å¼€å‘æœåŠ¡å™¨...' &&
        echo '   æœåŠ¡åœ°å€: http://localhost:3000' &&
        echo '   å®æ—¶æ—¥å¿—: âœ“' &&
        echo '   çƒ­é‡è½½: âœ“' &&
        echo '   å­˜å‚¨æ–¹å¼: JSONï¼ˆå¼€å‘ç¯å¢ƒï¼‰' &&
        echo '' &&
        npm run dev
      "
    # ç½‘ç»œé…ç½®
    networks:
      - fileupdate-dev

networks:
  fileupdate-dev:
    driver: bridge
